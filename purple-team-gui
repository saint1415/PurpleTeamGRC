#!/usr/bin/env python3
"""
Purple Team GRC Platform v3.0 - Desktop GUI Launcher
GTK-based graphical launcher for platform operations

Usage:
    purple-team-gui
"""

import gi
gi.require_version('Gtk', '3.0')
from gi.repository import Gtk, GLib
import subprocess
import threading

class PurpleTeamGUI(Gtk.Window):
    def __init__(self):
        Gtk.Window.__init__(self, title="Purple Team GRC Platform v3.0")
        self.set_border_width(20)
        self.set_default_size(600, 500)
        
        # Main container
        vbox = Gtk.Box(orientation=Gtk.Orientation.VERTICAL, spacing=10)
        self.add(vbox)
        
        # Header
        header = Gtk.Label()
        header.set_markup("<span size='x-large' weight='bold'>Purple Team GRC Platform v3.0</span>")
        vbox.pack_start(header, False, False, 10)
        
        # Notebook for categories
        notebook = Gtk.Notebook()
        vbox.pack_start(notebook, True, True, 0)
        
        # Network & Discovery Tab
        network_box = self.create_network_tab()
        notebook.append_page(network_box, Gtk.Label(label="Network & Discovery"))
        
        # Scanning Tab
        scan_box = self.create_scanning_tab()
        notebook.append_page(scan_box, Gtk.Label(label="Vulnerability Scanning"))
        
        # Compliance Tab
        compliance_box = self.create_compliance_tab()
        notebook.append_page(compliance_box, Gtk.Label(label="Compliance"))
        
        # Reports Tab
        reports_box = self.create_reports_tab()
        notebook.append_page(reports_box, Gtk.Label(label="Reports & Evidence"))
        
        # System Tab
        system_box = self.create_system_tab()
        notebook.append_page(system_box, Gtk.Label(label="System Management"))
        
        # Status bar
        self.status_label = Gtk.Label(label="Ready")
        self.status_label.set_halign(Gtk.Align.START)
        vbox.pack_start(self.status_label, False, False, 5)
    
    def create_network_tab(self):
        """Create network & discovery tab"""
        box = Gtk.Box(orientation=Gtk.Orientation.VERTICAL, spacing=10)
        box.set_border_width(10)
        
        btn1 = Gtk.Button(label="Network Discovery & Auto-Detection")
        btn1.connect("clicked", self.on_network_discovery)
        box.pack_start(btn1, False, False, 0)
        
        btn2 = Gtk.Button(label="Quick Network Scan")
        btn2.connect("clicked", self.on_quick_network_scan)
        box.pack_start(btn2, False, False, 0)
        
        btn3 = Gtk.Button(label="Full Network Scan")
        btn3.connect("clicked", self.on_full_network_scan)
        box.pack_start(btn3, False, False, 0)
        
        return box
    
    def create_scanning_tab(self):
        """Create vulnerability scanning tab"""
        box = Gtk.Box(orientation=Gtk.Orientation.VERTICAL, spacing=10)
        box.set_border_width(10)
        
        btn1 = Gtk.Button(label="Quick Vulnerability Scan (Sample)")
        btn1.connect("clicked", self.on_quick_vuln_scan)
        box.pack_start(btn1, False, False, 0)
        
        btn2 = Gtk.Button(label="Full Vulnerability Scan")
        btn2.connect("clicked", self.on_full_vuln_scan)
        box.pack_start(btn2, False, False, 0)
        
        # IP entry for targeted scan
        hbox = Gtk.Box(orientation=Gtk.Orientation.HORIZONTAL, spacing=10)
        hbox.pack_start(Gtk.Label(label="Target IP:"), False, False, 0)
        self.ip_entry = Gtk.Entry()
        self.ip_entry.set_placeholder_text("e.g., 10.50.25.143")
        hbox.pack_start(self.ip_entry, True, True, 0)
        
        btn3 = Gtk.Button(label="Scan Target")
        btn3.connect("clicked", self.on_targeted_scan)
        hbox.pack_start(btn3, False, False, 0)
        
        box.pack_start(hbox, False, False, 0)
        
        return box
    
    def create_compliance_tab(self):
        """Create compliance tab"""
        box = Gtk.Box(orientation=Gtk.Orientation.VERTICAL, spacing=10)
        box.set_border_width(10)
        
        btn1 = Gtk.Button(label="Run Compliance Scan")
        btn1.connect("clicked", self.on_compliance_scan)
        box.pack_start(btn1, False, False, 0)
        
        btn2 = Gtk.Button(label="Generate Compliance Report")
        btn2.connect("clicked", self.on_compliance_report)
        box.pack_start(btn2, False, False, 0)
        
        return box
    
    def create_reports_tab(self):
        """Create reports & evidence tab"""
        box = Gtk.Box(orientation=Gtk.Orientation.VERTICAL, spacing=10)
        box.set_border_width(10)
        
        btn1 = Gtk.Button(label="Generate Executive Report")
        btn1.connect("clicked", self.on_executive_report)
        box.pack_start(btn1, False, False, 0)
        
        btn2 = Gtk.Button(label="Create Evidence Package")
        btn2.connect("clicked", self.on_evidence_package)
        box.pack_start(btn2, False, False, 0)
        
        return box
    
    def create_system_tab(self):
        """Create system management tab"""
        box = Gtk.Box(orientation=Gtk.Orientation.VERTICAL, spacing=10)
        box.set_border_width(10)
        
        btn1 = Gtk.Button(label="Run Pre-Flight Checks")
        btn1.connect("clicked", self.on_preflight_check)
        box.pack_start(btn1, False, False, 0)
        
        btn2 = Gtk.Button(label="Check for Updates")
        btn2.connect("clicked", self.on_check_updates)
        box.pack_start(btn2, False, False, 0)
        
        btn3 = Gtk.Button(label="Sync Installations")
        btn3.connect("clicked", self.on_sync_installations)
        box.pack_start(btn3, False, False, 0)
        
        return box
    
    def update_status(self, message):
        """Update status bar"""
        GLib.idle_add(self.status_label.set_text, message)
    
    def run_command(self, cmd, description):
        """Run command in terminal"""
        self.update_status(f"Running: {description}...")
        terminal_cmd = f"x-terminal-emulator -e 'bash -c \"{cmd}; read -p \\\"Press Enter to close...\\\"\"'"
        threading.Thread(target=lambda: subprocess.run(terminal_cmd, shell=True)).start()
        GLib.timeout_add_seconds(2, lambda: self.update_status("Ready"))
    
    # Event handlers
    def on_network_discovery(self, widget):
        self.run_command("sudo python3 /opt/purple-team/bin/network-detector.py", "Network Discovery")
    
    def on_quick_network_scan(self, widget):
        self.run_command("sudo python3 /opt/purple-team/scanners/quick_scan.py", "Quick Network Scan")
    
    def on_full_network_scan(self, widget):
        self.run_command("sudo python3 /opt/purple-team/scanners/network_scanner.py", "Full Network Scan")
    
    def on_quick_vuln_scan(self, widget):
        self.run_command("sudo python3 /opt/purple-team/scanners/vulnerability_scanner.py --sample 10", "Quick Vulnerability Scan")
    
    def on_full_vuln_scan(self, widget):
        self.run_command("sudo python3 /opt/purple-team/scanners/vulnerability_scanner.py", "Full Vulnerability Scan")
    
    def on_targeted_scan(self, widget):
        ip = self.ip_entry.get_text()
        if ip:
            self.run_command(f"sudo python3 /opt/purple-team/scanners/quick_scan.py vuln {ip}", f"Scanning {ip}")
        else:
            self.update_status("Please enter target IP address")
    
    def on_compliance_scan(self, widget):
        self.run_command("sudo python3 /opt/purple-team/scanners/compliance_checker.py", "Compliance Scan")
    
    def on_compliance_report(self, widget):
        self.run_command("sudo python3 /opt/purple-team/utilities/executive_report_generator.py", "Compliance Report")
    
    def on_executive_report(self, widget):
        self.run_command("sudo python3 /opt/purple-team/utilities/executive_report_generator.py", "Executive Report")
    
    def on_evidence_package(self, widget):
        self.run_command("sudo python3 /opt/purple-team/utilities/evidence_manager.py --create-package", "Evidence Package")
    
    def on_preflight_check(self, widget):
        self.run_command("sudo python3 /opt/purple-team/bin/pre-flight-checker.py --verbose", "Pre-Flight Check")
    
    def on_check_updates(self, widget):
        self.run_command("sudo python3 /opt/purple-team/bin/update-manager.py", "Update Check")
    
    def on_sync_installations(self, widget):
        self.run_command("sudo /opt/purple-team/bin/sync-manager.sh --verbose", "Sync Installations")

def main():
    win = PurpleTeamGUI()
    win.connect("destroy", Gtk.main_quit)
    win.show_all()
    Gtk.main()

if __name__ == "__main__":
    main()
